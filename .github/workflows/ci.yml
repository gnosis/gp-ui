name: Continuous Integration

# Run on every commit
on: push

jobs:
  # comment_with_app_urls:
  #   name: Add App Urls as a comment in the PR
  #   runs-on: ubuntu-latest
  #   on: pull_request

  ci:
    name: Continuous Integration
    runs-on: ubuntu-latest
    env:
        APP_ID: 1
        REPO_NAME_SLUG: gpui

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      # - name: Set up node
      #   uses: actions/setup-node@v2
      #   with:
      #     node-version: 12

      # - name: Set output of cache
      #   id: yarn-cache
      #   run: echo "::set-output name=dir::$(yarn cache dir)"

      # - name: Install dependencies
      #   run: yarn install --frozen-lockfile

      # - name: Coverage
      #   run: yarn test:coverage

      # - name: Coveralls
      #   uses: coverallsapp/github-action@v1.1.2
      #   with:
      #     github-token: ${{ secrets.GITHUB_TOKEN }}

      # - name: Build Web Apps
      #   run: yarn build

      - uses: jwalton/gh-find-current-pr@v1
        id: findPr
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # - uses: mshick/add-pr-comment@v1
      #   with:
      #     message: |
      #       * **ðŸ”­ [Explorer Dapp](${{ env.REVIEW_FEATURE_URL }})**: Explorer test app
      #       * **ðŸ“ˆ [Trade Dapp](${{ env.REVIEW_FEATURE_URL }}/trade.html)**: Trade test app
      #       * **ðŸ“š [Storybook](${{ env.REVIEW_FEATURE_URL }}/storybook/)**: Component stories
      #     repo-token: ${{ secrets.GITHUB_TOKEN }}
      #     repo-token-user-login: 'github-actions[bot]'
      #     if: success() && steps.findPr.outputs.number
      #   env:
      #     REVIEW_FEATURE_URL: https://pr${{ steps.findPr.outputs.number }}--${{ env.REPO_NAME_SLUG }}.review.gnosisdev.com

      # # TODO: Conditionally run integration tests
      # #- if [[ $TRAVIS_TAG != "" || $TRAVIS_BRANCH = master || $TRAVIS_BRANCH = develop ]]; then
      # #  yarn test:integration;
      # #fi

      # # TODO: Branch dependent conf: The Old web had PRICE_ESTIMATOR_URL injected by travis. It would be good to find a cleaner way to allow branch dependant conf

      # # TODO: Generate IPFS for the Dapps

      # # TODO: Generate RELEASE_NOTES.md

      # # TODO: Conditionally generate the story book: In the old web it was created only in some branches
      # #       if [[ $TRAVIS_TAG != "" || $TRAVIS_PULL_REQUEST != "false" || $TRAVIS_BRANCH = master || $TRAVIS_BRANCH = develop ]]; then

      # - name: Build Storybook
      #   run: yarn build-storybook -o dist/storybook;

      - uses: shallwefootball/s3-upload-action@master
        with:
          aws_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY}}
          aws_bucket: "${{ secrets.AWS_REVIEW_BUCKET_NAME }}/${{ env.REPO_NAME_SLUG }}/pr${{ steps.findPr.outputs.number }}"          
          source_dir: docs

      # - name: Deploy to S3
      #   uses: jakejarvis/s3-sync-action@master
      #   with:
      #     args: --delete
      #   if: success() && steps.findPr.outputs.number
      #   env:
      #     AWS_S3_BUCKET: "${{ secrets.AWS_REVIEW_BUCKET_NAME }}/${{ env.REPO_NAME_SLUG }}/pr${{ steps.findPr.outputs.number }}"
      #     AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     AWS_REGION: ${{ secrets.AWS_REGION }}
      #     SOURCE_DIR: docs
    